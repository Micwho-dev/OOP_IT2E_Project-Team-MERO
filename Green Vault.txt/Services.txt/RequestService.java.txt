package services;

import dao.RequestDAO;
import dao.WasteRecordDAO;
import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

/**
 * Service class for managing requests.
 * Uses database for all operations via RequestDAO and WasteRecordDAO.
 */
public class RequestService {
    
    /**
     * Creates a new request.
     * First saves to .txt file, then automatically imports to database.
     * @param requesterUsername The username of the requester
     * @param barangay The barangay
     * @param requestType The type of request
     * @param location The location of the request
     * @param description The request description
     * @param numSacks Number of sacks of waste
     * @param wasteType Type of waste (Malata, Di Malata, Magagamit Pa, Hazardous)
     * @return true if successful, false otherwise
     */
    public static boolean createRequest(String requesterUsername, String barangay, 
                                        String requestType, String location, String description, int numSacks, String wasteType) {
        // Step 1: Save to .txt file first
            String timestamp = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date());
            String locationStr = (location == null || location.isEmpty()) ? "N/A" : location;
        String targetRole = "Barangay Captain"; // Default target role for new requests
        
        // Determine which file to save to based on target role
        String fileName = "data/requestform.txt"; // Default file
        if ("Barangay Captain".equals(targetRole)) {
            fileName = "data/requestformbarangaycaptain.txt";
        } else if ("City Officer".equals(targetRole)) {
            fileName = "data/requestformcityoffer.txt";
        } else if ("Garbage Collector".equals(targetRole)) {
            fileName = "data/requestformgarbagecollector.txt";
        } else if ("Waste Manager".equals(targetRole)) {
            fileName = "data/requestformwastemanagement.txt";
        }
        
        File txtFile = new File(fileName);
        
        try {
            // Ensure data directory exists
            txtFile.getParentFile().mkdirs();
            
            // Append to .txt file (pipe-delimited format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status)
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile, true))) {
                // Check if file is empty or doesn't exist, write header
                if (!txtFile.exists() || txtFile.length() == 0) {
                    writer.write("# Requests for " + targetRole);
                    writer.newLine();
                    writer.write("# Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status");
                    writer.newLine();
                    writer.newLine();
                }
                
                // Write request data (id will be generated by database, use 0 as placeholder)
                writer.write("0|" + timestamp + "|" + requesterUsername + "|" + barangay + "|" + 
                           requestType + "|" + locationStr + "|" + (description != null ? description : "") + "|" + 
                           numSacks + "|" + (wasteType != null ? wasteType : "") + "|Pending");
                writer.newLine();
                writer.flush();
            }
            
            // Step 2: Automatically import from .txt to database
            int id = RequestDAO.createRequest(timestamp, requesterUsername, barangay, requestType, 
                                            locationStr, description, numSacks, wasteType, 
                                            "Pending", targetRole);
            return id > 0;
            
        } catch (IOException e) {
            System.err.println("Error writing to .txt file: " + e.getMessage());
            e.printStackTrace();
            // Still try to save to database even if .txt write fails
            try {
                int id = RequestDAO.createRequest(timestamp, requesterUsername, barangay, requestType, 
                                                locationStr, description, numSacks, wasteType, 
                                                "Pending", targetRole);
                return id > 0;
            } catch (SQLException sqlEx) {
                System.err.println("Error creating request: " + sqlEx.getMessage());
                sqlEx.printStackTrace();
                return false;
            }
        } catch (SQLException e) {
            System.err.println("Error creating request: " + e.getMessage());
            e.printStackTrace();
            return false;
        }
    }
    
    /**
     * Gets all requests from requestform.txt filtered by barangay.
     * @param barangay The barangay to filter by
     * @return List of requests {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
     */
    public static List<Object[]> getBarangayRequests(String barangay) {
        List<Object[]> result = new ArrayList<>();
        try {
            List<Object[]> requests = RequestDAO.getRequestsByBarangay(barangay);
            
            for (Object[] req : requests) {
                // Database format: {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
                // Service format: {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
                
                String status = (String) req[9];
                String targetRole = (String) req[10];
                
                // Only include pending requests targeted at Barangay Captain
                if ("Pending".equals(status) && ("Barangay Captain".equals(targetRole) || targetRole == null)) {
                    result.add(new Object[]{
                        req[0],  // id
                        req[1],  // timestamp
                        req[2],  // requester
                        req[3],  // barangay
                        req[4],  // type (request_type)
                        req[5],  // location
                        req[6],  // description
                        req[7],  // numSacks (num_sacks)
                        req[8],  // wasteType (waste_type)
                        req[9]   // status
                    });
                }
            }
        } catch (SQLException e) {
            System.err.println("Error loading requests: " + e.getMessage());
        }
        
        return result;
    }
    
    /**
     * Forwards a request to Barangay Captain.
     * @param requestData The request data {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
     * @return true if successful, false otherwise
     */
    public static boolean forwardToBarangayCaptain(Object[] requestData) {
        // This is already handled in createRequest - new requests go to Barangay Captain
        return true;
    }
    
    /**
     * Gets all requests for Barangay Captain.
     * @return List of requests {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
     */
    public static List<Object[]> getBarangayCaptainRequests() {
        List<Object[]> result = new ArrayList<>();
        try {
            List<Object[]> requests = RequestDAO.getRequestsByTargetRole("Barangay Captain");
            
            for (Object[] req : requests) {
                result.add(convertToServiceFormat(req));
            }
        } catch (SQLException e) {
            System.err.println("Error loading Barangay Captain requests: " + e.getMessage());
        }
        
        return result;
    }
    
    /**
     * Updates the status of a request for Barangay Captain.
     * @param requestId The request ID
     * @param timestamp The request timestamp (for unique identification)
     * @param newStatus The new status (e.g., "Approved", "Rejected", "Completed")
     * @return true if successful, false otherwise
     */
    public static boolean updateBarangayCaptainRequestStatus(int requestId, String timestamp, String newStatus) {
        try {
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null) {
                return false;
            }
            
            // Verify timestamp matches
            if (!timestamp.equals(request[1])) {
                return false;
            }
            
            // If rejected, delete the request from database and file
            if (newStatus != null && newStatus.toLowerCase().contains("rejected")) {
                boolean dbDeleted = RequestDAO.deleteRequest(requestId);
                if (dbDeleted) {
                    // Remove from Barangay Captain file (use timestamp from database request for exact match)
                    String dbTimestamp = (String) request[1];
                    removeRequestFromBarangayCaptainFile(requestId, dbTimestamp);
                }
                return dbDeleted;
            }
            
            return RequestDAO.updateRequestStatus(requestId, newStatus);
        } catch (SQLException e) {
            System.err.println("Error updating Barangay Captain request: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Forwards an approved request from Barangay Captain to City Officer.
     * @param requestData The request data {id, timestamp, requester, barangay, area, type, description, numSacks, wasteType, status}
     * @return true if successful, false otherwise
     */
    public static boolean forwardToCityOfficer(Object[] requestData) {
        try {
            int requestId = (Integer) requestData[0];
            String timestamp = (String) requestData[1];
            
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null || !timestamp.equals(request[1])) {
                return false;
            }
            
            // Update database
            boolean dbSuccess = RequestDAO.updateRequestTargetRole(requestId, "City Officer") &&
                   RequestDAO.updateRequestStatus(requestId, "Pending (City Officer)");
            
            if (dbSuccess) {
                // Remove from Barangay Captain file (use timestamp from database request for exact match)
                String dbTimestamp = (String) request[1];
                removeRequestFromBarangayCaptainFile(requestId, dbTimestamp);
                
                // Add to City Officer file
                addRequestToCityOfficerFile(request);
            }
            
            return dbSuccess;
        } catch (SQLException e) {
            System.err.println("Error forwarding request to City Officer: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Forwards a new request directly from Barangay Captain's view to City Officer.
     * This is used when the Captain approves a Barangay Member request in the
     * generic "View Requests" panel and we want it to go straight to City Officer.
     */
    public static boolean forwardFromMemberToCityOfficer(String barangay, Object[] requestData) {
        try {
            int requestId = (Integer) requestData[0];
            String timestamp = (String) requestData[1];
            
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null || !timestamp.equals(request[1])) {
                return false;
            }
            
            // Update database
            boolean dbSuccess = RequestDAO.updateRequestTargetRole(requestId, "City Officer") &&
                   RequestDAO.updateRequestStatus(requestId, "Pending (City Officer)");
            
            if (dbSuccess) {
                // Remove from Barangay Captain file (use timestamp from database request for exact match)
                String dbTimestamp = (String) request[1];
                removeRequestFromBarangayCaptainFile(requestId, dbTimestamp);
                
                // Add to City Officer file
                addRequestToCityOfficerFile(request);
            }
            
            return dbSuccess;
        } catch (SQLException e) {
            System.err.println("Error forwarding member request directly to City Officer: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Gets all requests for City Officer.
     * @return List of requests {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
     */
    public static List<Object[]> getCityOfficerRequests() {
        List<Object[]> result = new ArrayList<>();
        try {
            List<Object[]> requests = RequestDAO.getRequestsByTargetRole("City Officer");
            
            for (Object[] req : requests) {
                result.add(convertToServiceFormat(req));
            }
        } catch (SQLException e) {
            System.err.println("Error loading City Officer requests: " + e.getMessage());
        }
        
        return result;
    }
    
    /**
     * Updates the status of a request for City Officer.
     * @param requestId The request ID
     * @param timestamp The request timestamp
     * @param newStatus New status text
     */
    public static boolean updateCityOfficerRequestStatus(int requestId, String timestamp, String newStatus) {
        try {
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null || !timestamp.equals(request[1])) {
                return false;
            }
            
            // If rejected, delete the request from database and file
            if (newStatus != null && newStatus.toLowerCase().contains("rejected")) {
                boolean dbDeleted = RequestDAO.deleteRequest(requestId);
                if (dbDeleted) {
                    // Remove from City Officer file (use timestamp from database request for exact match)
                    String dbTimestamp = (String) request[1];
                    removeRequestFromCityOfficerFile(requestId, dbTimestamp);
                }
                return dbDeleted;
            }
            
            return RequestDAO.updateRequestStatus(requestId, newStatus);
        } catch (SQLException e) {
            System.err.println("Error updating City Officer request: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Forwards an approved request from City Officer to Garbage Collector.
     * @param requestData The request data
     * @return true if successful, false otherwise
     */
    public static boolean forwardToGarbageCollector(Object[] requestData) {
        try {
            int requestId = (Integer) requestData[0];
            String timestamp = (String) requestData[1];
            
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null || !timestamp.equals(request[1])) {
                return false;
            }
            
            // Update database
            boolean dbSuccess = RequestDAO.updateRequestTargetRole(requestId, "Garbage Collector") &&
                   RequestDAO.updateRequestStatus(requestId, "Pending (Garbage Collector)");
            
            if (dbSuccess) {
                // Remove from City Officer file (use timestamp from database request for exact match)
                String dbTimestamp = (String) request[1];
                removeRequestFromCityOfficerFile(requestId, dbTimestamp);
                
                // Add to Garbage Collector file
                addRequestToGarbageCollectorFile(request);
            }
            
            return dbSuccess;
        } catch (SQLException e) {
            System.err.println("Error forwarding request to Garbage Collector: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Gets all requests for Garbage Collector.
     * @return List of requests {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
     */
    public static List<Object[]> getGarbageCollectorRequests() {
        List<Object[]> result = new ArrayList<>();
        try {
            List<Object[]> requests = RequestDAO.getRequestsByTargetRole("Garbage Collector");
            
            for (Object[] req : requests) {
                result.add(convertToServiceFormat(req));
            }
        } catch (SQLException e) {
            System.err.println("Error loading Garbage Collector requests: " + e.getMessage());
        }
        
        return result;
    }
    
    /**
     * Updates the status of a request for Garbage Collector.
     */
    public static boolean updateGarbageCollectorRequestStatus(int requestId, String timestamp, String newStatus) {
        try {
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null || !timestamp.equals(request[1])) {
                return false;
            }
            
            // If rejected, delete the request from database and file
            if (newStatus != null && newStatus.toLowerCase().contains("rejected")) {
                boolean dbDeleted = RequestDAO.deleteRequest(requestId);
                if (dbDeleted) {
                    // Remove from Garbage Collector file (use timestamp from database request for exact match)
                    String dbTimestamp = (String) request[1];
                    removeRequestFromGarbageCollectorFile(requestId, dbTimestamp);
                }
                return dbDeleted;
            }
            
            String oldStatus = (String) request[9];
            
            // Update status
            boolean success = RequestDAO.updateRequestStatus(requestId, newStatus);
            
            // If the request has just been marked as completed by the Garbage Collector,
            // automatically create a corresponding Waste Log entry and remove from file
            if (success && !"Completed by Garbage Collector".equals(oldStatus)
                    && "Completed by Garbage Collector".equals(newStatus)) {
                try {
                    String fullTimestamp = (String) request[1];
                    String barangay = (String) request[3];
                    String location = (String) request[5];
                    if (location == null || location.equals("N/A")) {
                        location = barangay;
                    }
                    int numSacks = (Integer) request[7];
                    String wasteType = (String) request[8];
                    String description = (String) request[6];
                    
                    // Use the date portion of the timestamp (yyyy-MM-dd)
                    String dateOnly = fullTimestamp.split(" ")[0];
                    
                    // Extract weight from description (format: "Weight: X.XX kg | ...")
                    double weight = numSacks; // Default fallback to numSacks if weight not found
                    if (description != null && description.contains("Weight:")) {
                        try {
                            int weightIndex = description.indexOf("Weight:");
                            if (weightIndex != -1) {
                                int start = weightIndex + 7; // Skip "Weight:"
                                int end = description.indexOf(" kg", start);
                                if (end != -1) {
                                    String weightStr = description.substring(start, end).trim();
                                    weight = Double.parseDouble(weightStr);
                                }
                            }
                        } catch (Exception e) {
                            System.err.println("Error extracting weight from description, using numSacks as fallback: " + e.getMessage());
                            // Keep default weight = numSacks
                        }
                    }
                    
                    // Save to waste records (database and managewasterecord.txt file)
                    saveToManageWasteRecord(dateOnly, location, weight, wasteType, barangay);
                    
                    // Remove from Garbage Collector file since it's completed
                    String dbTimestamp = (String) request[1];
                    removeRequestFromGarbageCollectorFile(requestId, dbTimestamp);
                } catch (Exception e) {
                    System.err.println("Error auto-logging completed collection: " + e.getMessage());
                }
            }
            
            return success;
        } catch (SQLException e) {
            System.err.println("Error updating Garbage Collector request: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Updates the status of a request.
     * @param barangay The barangay
     * @param requestId The request ID
     * @param timestamp The request timestamp (for unique identification)
     * @param newStatus The new status (e.g., "Approved", "Rejected", "Completed")
     * @return true if successful, false otherwise
     */
    public static boolean updateRequestStatus(String barangay, int requestId, String timestamp, String newStatus) {
        try {
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null || !timestamp.equals(request[1])) {
                return false;
            }
            
            // If rejected, delete the request from database and file
            if (newStatus != null && newStatus.toLowerCase().contains("rejected")) {
                boolean dbDeleted = RequestDAO.deleteRequest(requestId);
                if (dbDeleted) {
                    // Determine which file to remove from based on target_role
                    // Use timestamp from database request for exact match
                    String dbTimestamp = (String) request[1];
                    String targetRole = (String) request[10]; // target_role is at index 10
                    if ("Barangay Captain".equals(targetRole) || targetRole == null) {
                        removeRequestFromBarangayCaptainFile(requestId, dbTimestamp);
                    } else if ("City Officer".equals(targetRole)) {
                        removeRequestFromCityOfficerFile(requestId, dbTimestamp);
                    } else if ("Waste Manager".equals(targetRole)) {
                        removeRequestFromWasteManagerFile(requestId, dbTimestamp);
                    } else if ("Garbage Collector".equals(targetRole)) {
                        removeRequestFromGarbageCollectorFile(requestId, dbTimestamp);
                    }
                }
                return dbDeleted;
            }
            
            return RequestDAO.updateRequestStatus(requestId, newStatus);
        } catch (SQLException e) {
            System.err.println("Error updating request: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Converts database format to service format.
     * Database format: {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
     * Service format: {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
     */
    private static Object[] convertToServiceFormat(Object[] dbRequest) {
        return new Object[]{
            dbRequest[0],  // id
            dbRequest[1],  // timestamp
            dbRequest[2],  // requester
            dbRequest[3],  // barangay
            dbRequest[4],  // type (request_type)
            dbRequest[5],  // location
            dbRequest[6],  // description
            dbRequest[7],  // numSacks (num_sacks)
            dbRequest[8],  // wasteType (waste_type)
            dbRequest[9]   // status
        };
    }
    
    /**
     * Saves a completed collection record to waste records.
     * Saves to both database and managewasterecord.txt file.
     * @param date The date of collection
     * @param location The location of collection
     * @param weight The weight in kg
     * @param wasteType The type of waste
     * @param barangay The barangay (stored but not shown in GUI)
     */
    public static void saveToManageWasteRecord(String date, String location, double weight, String wasteType, String barangay) {
        try {
            // Step 1: Save to database first to get the generated ID
            int newId = WasteRecordDAO.createWasteRecord("Garbage Collector", date, location, weight, wasteType, barangay);
            
            // Step 2: Save to managewasterecord.txt file
            if (newId > 0) {
                File txtFile = new File("data/managewasterecord.txt");
                
                try {
                    // Ensure data directory exists
                    txtFile.getParentFile().mkdirs();
                    
                    // Append to .txt file (format: id|date|location|weight|type|barangay)
                    try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile, true))) {
                        // Check if file is empty or doesn't exist, write header
                        if (!txtFile.exists() || txtFile.length() == 0) {
                            writer.write("# Waste Logs Records Management");
                            writer.newLine();
                            writer.write("# Format: id|date|location|weight|type|barangay");
                            writer.newLine();
                            writer.newLine();
                        }
                        
                        // Write waste record data
                        String locationStr = (location == null || location.isEmpty()) ? "N/A" : location;
                        String wasteTypeStr = (wasteType == null) ? "" : wasteType;
                        String barangayStr = (barangay == null) ? "" : barangay;
                        // Format weight to preserve full precision (use 2 decimal places)
                        String weightStr = String.format("%.2f", weight);
                        
                        writer.write(newId + "|" + date + "|" + locationStr + "|" + weightStr + "|" + wasteTypeStr + "|" + barangayStr);
                        writer.newLine();
                        writer.flush();
                    }
                } catch (IOException e) {
                    System.err.println("Error writing to managewasterecord.txt file: " + e.getMessage());
                    e.printStackTrace();
                    // Continue - database save was successful
                }
            }
        } catch (SQLException e) {
            System.err.println("Error saving to waste records: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Gets all records from waste records (for manage waste records view).
     * Reads from database (which now includes barangay column).
     * Returns {id, date, location, weight, type, barangay}
     * @return List of records {id, date, location, weight, type, barangay}
     */
    public static List<Object[]> getManageWasteRecords() {
        List<Object[]> result = new ArrayList<>();
        
        try {
            // Read from database (now includes barangay column)
            List<Object[]> records = WasteRecordDAO.getWasteRecordsByRole("Garbage Collector");
            for (Object[] record : records) {
                // Database format: {id, role, date, area, weight, type, barangay}
                // Service format: {id, date, location, weight, type, barangay}
                String location = (String) record[3]; // area
                String barangay = record.length >= 7 && record[6] != null ? (String) record[6] : "N/A";
                
                result.add(new Object[]{
                    record[0],      // id
                    record[2],      // date
                    location,       // location (from area)
                    record[4],      // weight
                    record[5],      // type
                    barangay        // barangay (from database)
                });
            }
        } catch (SQLException e) {
            System.err.println("Error loading from database: " + e.getMessage());
            // Fallback to file if database read fails
            File txtFile = new File("data/managewasterecord.txt");
            if (txtFile.exists()) {
                try (BufferedReader reader = new BufferedReader(new FileReader(txtFile))) {
                    String line;
                    while ((line = reader.readLine()) != null) {
                        line = line.trim();
                        // Skip empty lines and comments
                        if (line.isEmpty() || line.startsWith("#")) {
                            continue;
                        }
                        
                        // Parse pipe-delimited format: id|date|location|weight|type|barangay
                        String[] parts = line.split("\\|");
                        if (parts.length >= 6) {
                            try {
                                int id = Integer.parseInt(parts[0].trim());
                                String date = parts[1].trim();
                                String location = parts[2].trim();
                                double weight = Double.parseDouble(parts[3].trim());
                                String type = parts[4].trim();
                                String barangay = parts[5].trim();
                                
                                result.add(new Object[]{
                                    id,         // id
                                    date,       // date
                                    location,   // location
                                    weight,     // weight
                                    type,       // type
                                    barangay    // barangay (from file)
                                });
                            } catch (NumberFormatException ex) {
                                System.err.println("Error parsing line in managewasterecord.txt: " + line);
                            }
                        }
                    }
                } catch (IOException ioE) {
                    System.err.println("Error reading managewasterecord.txt: " + ioE.getMessage());
                }
            }
        }
        
        return result;
    }
    
    /**
     * Saves all records to waste records with barangay.
     * Saves to both database and managewasterecord.txt file.
     * @param records List of records {id, date, location, weight, type, barangay} from GUI
     */
    public static void saveManageWasteRecordsWithBarangay(List<Object[]> records) {
        File txtFile = new File("data/managewasterecord.txt");
        
        try {
            // Step 1: Delete all existing Garbage Collector records from database
            List<Object[]> existing = WasteRecordDAO.getWasteRecordsByRole("Garbage Collector");
            for (Object[] rec : existing) {
                WasteRecordDAO.deleteWasteRecord((Integer) rec[0]);
            }
            
            // Step 2: Save new records to database and get new IDs
            List<Object[]> recordsWithIds = new ArrayList<>();
            for (Object[] record : records) {
                // Format: {id, date, location, weight, type, barangay}
                String date = (String) record[1];
                String location = (String) record[2];
                // Handle weight - could be Number, String, or Double
                double weight;
                if (record[3] instanceof Number) {
                    weight = ((Number) record[3]).doubleValue();
                } else if (record[3] instanceof String) {
                    try {
                        weight = Double.parseDouble(((String) record[3]).trim());
                    } catch (NumberFormatException e) {
                        System.err.println("Invalid weight value: " + record[3]);
                        continue; // Skip this record
                    }
                } else {
                    System.err.println("Invalid weight type: " + record[3].getClass());
                    continue; // Skip this record
                }
                String type = (String) record[4];
                String barangay = record.length >= 6 && record[5] != null ? (String) record[5] : "N/A";
                
                int newId = WasteRecordDAO.createWasteRecord("Garbage Collector", date, location, weight, type, barangay);
                if (newId > 0) {
                    recordsWithIds.add(new Object[]{
                        newId, date, location, weight, type, barangay
                    });
                }
            }
            
            // Step 3: Save to managewasterecord.txt file (overwrite entire file)
            try {
                txtFile.getParentFile().mkdirs();
                try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile, false))) {
                    // Write header
                    writer.write("# Waste Logs Records Management");
                    writer.newLine();
                    writer.write("# Format: id|date|location|weight|type|barangay");
                    writer.newLine();
                    writer.newLine();
                    
                    // Write all records
                    for (Object[] record : recordsWithIds) {
                        int id = (Integer) record[0];
                        String date = (String) record[1];
                        String location = (String) record[2];
                        double weight = ((Number) record[3]).doubleValue();
                        String type = (String) record[4];
                        String barangay = (String) record[5];
                        
                        String locationStr = (location == null || location.isEmpty()) ? "N/A" : location;
                        String wasteTypeStr = (type == null) ? "" : type;
                        String barangayStr = (barangay == null || barangay.isEmpty()) ? "N/A" : barangay;
                        // Format weight to preserve full precision (use 2 decimal places)
                        String weightStr = String.format("%.2f", weight);
                        
                        writer.write(id + "|" + date + "|" + locationStr + "|" + weightStr + "|" + wasteTypeStr + "|" + barangayStr);
                        writer.newLine();
                    }
                    writer.flush();
                }
            } catch (IOException e) {
                System.err.println("Error writing to managewasterecord.txt file: " + e.getMessage());
                e.printStackTrace();
            }
        } catch (SQLException e) {
            System.err.println("Error saving waste records: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Saves all records to waste records.
     * Reads existing records to preserve barangay data, then saves with barangay.
     * @param records List of records {id, date, location, weight, type} from GUI
     */
    public static void saveManageWasteRecords(List<Object[]> records) {
        // Same as saveManageWasteRecordsWithBarangay since we use location/area
        saveManageWasteRecordsWithBarangay(records);
    }
    
    /**
     * Deletes a record from waste records by ID.
     * Deletes from both database and managewasterecord.txt file.
     * @param id The record ID to delete
     */
    public static void deleteManageWasteRecord(int id) {
        try {
            // Step 1: Delete from database first
            boolean dbDeleted = WasteRecordDAO.deleteWasteRecord(id);
            if (!dbDeleted) {
                System.err.println("Warning: Record ID " + id + " not found in database");
            }
            
            // Step 2: Delete from managewasterecord.txt file by reading directly from file
            File txtFile = new File("data/managewasterecord.txt");
            if (txtFile.exists()) {
                List<String> remainingLines = new ArrayList<>();
                boolean found = false;
                
                // Read all lines from file
                try (BufferedReader reader = new BufferedReader(new FileReader(txtFile))) {
                    String line;
                    while ((line = reader.readLine()) != null) {
                        // Keep header lines
                        if (line.trim().isEmpty() || line.startsWith("#")) {
                            remainingLines.add(line);
                            continue;
                        }
                        
                        // Parse pipe-delimited format: id|date|location|weight|type|barangay
                        String[] parts = line.split("\\|");
                        if (parts.length >= 1) {
                            try {
                                int fileId = Integer.parseInt(parts[0].trim());
                                // Skip the line if ID matches
                                if (fileId == id) {
                                    found = true;
                                    continue; // Don't add this line
                                }
                            } catch (NumberFormatException ex) {
                                // If ID parsing fails, keep the line
                            }
                        }
                        
                        // Add line if ID doesn't match
                        remainingLines.add(line);
                    }
                } catch (IOException e) {
                    System.err.println("Error reading managewasterecord.txt file: " + e.getMessage());
                    e.printStackTrace();
                    return; // Exit if we can't read the file
                }
                
                // Rewrite the file with remaining lines
                try {
                    txtFile.getParentFile().mkdirs();
                    try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile, false))) {
                        for (String line : remainingLines) {
                            writer.write(line);
                            writer.newLine();
                        }
                        writer.flush();
                    }
                    
                    if (found || dbDeleted) {
                        System.out.println("Successfully deleted record ID " + id + " from both database and file");
                    }
                } catch (IOException e) {
                    System.err.println("Error updating managewasterecord.txt file: " + e.getMessage());
                    e.printStackTrace();
                }
            } else {
                // File doesn't exist, but database delete succeeded
                if (dbDeleted) {
                    System.out.println("Record ID " + id + " deleted from database (file doesn't exist)");
                }
            }
        } catch (SQLException e) {
            System.err.println("Error deleting waste record from database: " + e.getMessage());
            e.printStackTrace();
        }
    }

    /**
     * Returns a lightweight summary of all requests for reporting purposes.
     * Format: {id, timestamp, requester, barangay, type, status}
     */
    public static java.util.List<Object[]> getAllRequestsSummary() {
        java.util.List<Object[]> result = new java.util.ArrayList<>();
        try {
            java.util.List<Object[]> all = RequestDAO.getAllRequests();
            for (Object[] req : all) {
                // {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
                result.add(new Object[]{
                    req[0], // id
                    req[1], // timestamp
                    req[2], // requester
                    req[3], // barangay
                    req[4], // type
                    req[9]  // status
                });
            }
        } catch (SQLException e) {
            System.err.println("Error loading requests summary: " + e.getMessage());
        }
        return result;
    }

    /**
     * Exports all requests to a CSV file.
     * Columns: id,timestamp,requester,barangay,request_type,location,description,num_sacks,waste_type,status,target_role
     *
     * @param file target file (CSV or .txt)
     * @return true if successful, false otherwise
     */
    public static boolean exportRequestsToCsv(File file) {
        if (file == null) return false;
        try (BufferedWriter writer = new BufferedWriter(new FileWriter(file))) {
            // Header
            writer.write("id,timestamp,requester,barangay,request_type,location,description,num_sacks,waste_type,status,target_role");
            writer.newLine();

            java.util.List<Object[]> all = RequestDAO.getAllRequests();
            for (Object[] req : all) {
                // Escape commas by wrapping text in quotes if needed
                String line = String.format("%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s",
                        safeCsv(req[0]),
                        safeCsv(req[1]),
                        safeCsv(req[2]),
                        safeCsv(req[3]),
                        safeCsv(req[4]),
                        safeCsv(req[5]),
                        safeCsv(req[6]),
                        safeCsv(req[7]),
                        safeCsv(req[8]),
                        safeCsv(req[9]),
                        safeCsv(req[10])
                );
                writer.write(line);
                writer.newLine();
            }
            writer.flush();
            return true;
        } catch (IOException | SQLException e) {
            System.err.println("Error exporting requests to CSV: " + e.getMessage());
            e.printStackTrace();
            return false;
        }
    }

    // Helper for safe CSV cell formatting
    private static String safeCsv(Object value) {
        if (value == null) return "";
        String text = String.valueOf(value);
        // If contains comma or quote, wrap in quotes and escape internal quotes
        if (text.contains(",") || text.contains("\"") || text.contains("\n")) {
            text = text.replace("\"", "\"\"");
            return "\"" + text + "\"";
        }
        return text;
    }

    /**
     * Removes a request from the requestformbarangaycaptain.txt file.
     * @param requestId The request ID (not used for matching, file has placeholder 0)
     * @param timestamp The request timestamp for identification (unique identifier)
     */
    private static void removeRequestFromBarangayCaptainFile(int requestId, String timestamp) {
        File txtFile = new File("data/requestformbarangaycaptain.txt");
        
        if (!txtFile.exists()) {
            return; // File doesn't exist, nothing to do
        }
        
        try {
            // Read all lines from file
            List<String> lines = new ArrayList<>();
            boolean found = false;
            
            try (BufferedReader reader = new BufferedReader(new FileReader(txtFile))) {
                String line;
                while ((line = reader.readLine()) != null) {
                    // Skip the line if it matches the request to remove (match by timestamp since file has placeholder ID 0)
                    if (!line.trim().isEmpty() && !line.startsWith("#")) {
                        String[] parts = line.split("\\|", -1); // Use -1 to preserve empty strings
                        // Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                        if (parts.length >= 2) {
                            String fileTimestamp = parts[1].trim();
                            String trimmedTimestamp = timestamp.trim();
                            // Match by timestamp only (file has placeholder ID 0, but database has real ID)
                            if (fileTimestamp.equals(trimmedTimestamp)) {
                                // Skip this line (don't add it to lines list)
                                found = true;
                                System.out.println("Removing request from barangay captain file: timestamp=" + trimmedTimestamp);
                                continue;
                            }
                        }
                    }
                    
                    lines.add(line);
                }
            }
            
            // Write updated content back to file only if we found a match
            if (found) {
                try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile))) {
                    for (String line : lines) {
                        writer.write(line);
                        writer.newLine();
                    }
                    writer.flush();
                }
                System.out.println("Successfully removed request from requestformbarangaycaptain.txt");
            } else {
                System.err.println("Warning: Request with timestamp '" + timestamp.trim() + "' not found in requestformbarangaycaptain.txt file");
            }
            
        } catch (IOException e) {
            System.err.println("Error removing request from requestformbarangaycaptain.txt file: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Adds a request to the requestformcityoffer.txt file.
     * @param request The request data from database {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
     */
    private static void addRequestToCityOfficerFile(Object[] request) {
        File txtFile = new File("data/requestformcityoffer.txt");
        
        try {
            // Ensure data directory exists
            txtFile.getParentFile().mkdirs();
            
            // Database format: {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
            int id = (Integer) request[0];
            String timestamp = (String) request[1];
            String requester = (String) request[2];
            String barangay = (String) request[3];
            String requestType = (String) request[4];
            String location = (String) request[5];
            String description = (String) request[6];
            int numSacks = (Integer) request[7];
            String wasteType = (String) request[8];
            String status = "Pending (City Officer)"; // Use the new status
            
            String locationStr = (location == null || location.isEmpty()) ? "N/A" : location;
            String descriptionStr = (description == null) ? "" : description;
            String wasteTypeStr = (wasteType == null) ? "" : wasteType;
            
            // Append to .txt file
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile, true))) {
                // Check if file is empty or doesn't exist, write header
                if (!txtFile.exists() || txtFile.length() == 0) {
                    writer.write("# Requests for City Officer (Approved by Barangay Captain) - All Request Types");
                    writer.newLine();
                    writer.write("# Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status");
                    writer.newLine();
                    writer.write("# Note: numSacks and wasteType are only used for Waste Collection requests");
                    writer.newLine();
                    writer.newLine();
                }
                
                // Write request data
                // Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                writer.write(id + "|" + timestamp + "|" + requester + "|" + barangay + "|" + 
                           requestType + "|" + locationStr + "|" + descriptionStr + "|" + 
                           numSacks + "|" + wasteTypeStr + "|" + status);
                writer.newLine();
                writer.flush();
            }
            
        } catch (IOException e) {
            System.err.println("Error adding request to requestformcityoffer.txt file: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Removes a request from the requestformcityoffer.txt file.
     * @param requestId The request ID (used for matching - file should have real ID when forwarded)
     * @param timestamp The request timestamp for identification
     */
    private static void removeRequestFromCityOfficerFile(int requestId, String timestamp) {
        File txtFile = new File("data/requestformcityoffer.txt");
        
        if (!txtFile.exists()) {
            return; // File doesn't exist, nothing to do
        }
        
        try {
            // Read all lines from file
            List<String> lines = new ArrayList<>();
            
            try (BufferedReader reader = new BufferedReader(new FileReader(txtFile))) {
                String line;
                while ((line = reader.readLine()) != null) {
                    // Skip the line if it matches the request to remove
                    if (!line.trim().isEmpty() && !line.startsWith("#")) {
                        String[] parts = line.split("\\|");
                        // Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                        if (parts.length >= 2) {
                            try {
                                int fileId = Integer.parseInt(parts[0].trim());
                                String fileTimestamp = parts[1].trim();
                                // Match by both ID and timestamp (file should have real ID when forwarded)
                                if (fileId == requestId && fileTimestamp.equals(timestamp)) {
                                    // Skip this line (don't add it to lines list)
                                    continue;
                                }
                            } catch (NumberFormatException e) {
                                // If ID parsing fails, try matching by timestamp only
                                String fileTimestamp = parts[1].trim();
                                if (fileTimestamp.equals(timestamp)) {
                                    continue;
                                }
                            }
                        }
                    }
                    
                    lines.add(line);
                }
            }
            
            // Write updated content back to file
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile))) {
                for (String line : lines) {
                    writer.write(line);
                    writer.newLine();
                }
                writer.flush();
            }
            
        } catch (IOException e) {
            System.err.println("Error removing request from requestformcityoffer.txt file: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Removes a request from the requestformwastemanagement.txt file.
     * @param requestId The request ID (used for matching - file should have real ID when forwarded)
     * @param timestamp The request timestamp for identification
     */
    private static void removeRequestFromWasteManagerFile(int requestId, String timestamp) {
        File txtFile = new File("data/requestformwastemanagement.txt");
        
        if (!txtFile.exists()) {
            return; // File doesn't exist, nothing to do
        }
        
        try {
            // Read all lines from file
            List<String> lines = new ArrayList<>();
            
            try (BufferedReader reader = new BufferedReader(new FileReader(txtFile))) {
                String line;
                while ((line = reader.readLine()) != null) {
                    // Skip the line if it matches the request to remove
                    if (!line.trim().isEmpty() && !line.startsWith("#")) {
                        String[] parts = line.split("\\|");
                        // Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                        if (parts.length >= 2) {
                            try {
                                int fileId = Integer.parseInt(parts[0].trim());
                                String fileTimestamp = parts[1].trim();
                                // Match by both ID and timestamp (file should have real ID when forwarded)
                                if (fileId == requestId && fileTimestamp.equals(timestamp)) {
                                    // Skip this line (don't add it to lines list)
                                    continue;
                                }
                            } catch (NumberFormatException e) {
                                // If ID parsing fails, try matching by timestamp only
                                String fileTimestamp = parts[1].trim();
                                if (fileTimestamp.equals(timestamp)) {
                                    continue;
                                }
                            }
                        }
                    }
                    
                    lines.add(line);
                }
            }
            
            // Write updated content back to file
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile))) {
                for (String line : lines) {
                    writer.write(line);
                    writer.newLine();
                }
                writer.flush();
            }
            
        } catch (IOException e) {
            System.err.println("Error removing request from requestformwastemanagement.txt file: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Adds a request to the requestformgarbagecollector.txt file.
     * @param request The request data from database {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
     */
    private static void addRequestToGarbageCollectorFile(Object[] request) {
        File txtFile = new File("data/requestformgarbagecollector.txt");
        
        try {
            // Ensure data directory exists
            txtFile.getParentFile().mkdirs();
            
            // Database format: {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
            int id = (Integer) request[0];
            String timestamp = (String) request[1];
            String requester = (String) request[2];
            String barangay = (String) request[3];
            String requestType = (String) request[4];
            String location = (String) request[5];
            String description = (String) request[6];
            int numSacks = (Integer) request[7];
            String wasteType = (String) request[8];
            String status = "Pending (Garbage Collector)"; // Use the new status
            
            String locationStr = (location == null || location.isEmpty()) ? "N/A" : location;
            String descriptionStr = (description == null) ? "" : description;
            String wasteTypeStr = (wasteType == null) ? "" : wasteType;
            
            // Append to .txt file
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile, true))) {
                // Check if file is empty or doesn't exist, write header
                if (!txtFile.exists() || txtFile.length() == 0) {
                    writer.write("# Requests for Garbage Collector (Approved by City Officer) - All Request Types");
                    writer.newLine();
                    writer.write("# Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status");
                    writer.newLine();
                    writer.write("# Note: numSacks and wasteType are only used for Waste Collection requests");
                    writer.newLine();
                    writer.newLine();
                }
                
                // Write request data
                // Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                writer.write(id + "|" + timestamp + "|" + requester + "|" + barangay + "|" + 
                           requestType + "|" + locationStr + "|" + descriptionStr + "|" + 
                           numSacks + "|" + wasteTypeStr + "|" + status);
                writer.newLine();
                writer.flush();
            }
            
        } catch (IOException e) {
            System.err.println("Error adding request to requestformgarbagecollector.txt file: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Removes a request from the requestformgarbagecollector.txt file.
     * @param requestId The request ID (used for matching - file should have real ID when forwarded)
     * @param timestamp The request timestamp for identification
     */
    private static void removeRequestFromGarbageCollectorFile(int requestId, String timestamp) {
        File txtFile = new File("data/requestformgarbagecollector.txt");
        
        if (!txtFile.exists()) {
            return; // File doesn't exist, nothing to do
        }
        
        try {
            // Read all lines from file
            List<String> lines = new ArrayList<>();
            
            try (BufferedReader reader = new BufferedReader(new FileReader(txtFile))) {
                String line;
                while ((line = reader.readLine()) != null) {
                    // Skip the line if it matches the request to remove
                    if (!line.trim().isEmpty() && !line.startsWith("#")) {
                        String[] parts = line.split("\\|");
                        // Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                        if (parts.length >= 2) {
                            try {
                                int fileId = Integer.parseInt(parts[0].trim());
                                String fileTimestamp = parts[1].trim();
                                // Match by both ID and timestamp (file should have real ID when forwarded)
                                if (fileId == requestId && fileTimestamp.equals(timestamp)) {
                                    // Skip this line (don't add it to lines list)
                                    continue;
                                }
                            } catch (NumberFormatException e) {
                                // If ID parsing fails, try matching by timestamp only
                                String fileTimestamp = parts[1].trim();
                                if (fileTimestamp.equals(timestamp)) {
                                    continue;
                                }
                            }
                        }
                    }
                    
                    lines.add(line);
                }
            }
            
            // Write updated content back to file
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile))) {
                for (String line : lines) {
                    writer.write(line);
                    writer.newLine();
                }
                writer.flush();
            }
            
        } catch (IOException e) {
            System.err.println("Error removing request from requestformgarbagecollector.txt file: " + e.getMessage());
            e.printStackTrace();
        }
    }

    /**
     * Imports requests from a .txt file (pipe-delimited format).
     * Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
     * 
     * @param file The .txt file to import from
     * @param defaultTargetRole The default target role if not specified (e.g., "Barangay Captain")
     * @return Number of requests successfully imported
     */
    public static int importRequestsFromTxt(File file, String defaultTargetRole) {
        if (file == null || !file.exists()) {
            return 0;
        }
        
        int imported = 0;
        int skipped = 0;
        
        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                line = line.trim();
                // Skip empty lines and comments
                if (line.isEmpty() || line.startsWith("#")) {
                    continue;
                }
                
                // Parse pipe-delimited format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                String[] parts = line.split("\\|");
                if (parts.length < 10) {
                    skipped++;
                    continue;
                }
                
                try {
                    // parts[0] = id (we'll ignore this, let DB generate new ID)
                    String timestamp = parts[1].trim();
                    String requester = parts[2].trim();
                    String barangay = parts[3].trim();
                    String requestType = parts[4].trim();
                    String location = parts[5].trim();
                    String description = parts[6].trim();
                    int numSacks = Integer.parseInt(parts[7].trim());
                    String wasteType = parts[8].trim();
                    String status = parts[9].trim();
                    
                    // Create request in database
                    int newId = RequestDAO.createRequest(timestamp, requester, barangay, requestType, 
                                                        location, description, numSacks, wasteType, 
                                                        status, defaultTargetRole);
                    if (newId > 0) {
                        imported++;
                    } else {
                        skipped++;
                    }
                } catch (NumberFormatException | SQLException e) {
                    System.err.println("Error importing line: " + line + " - " + e.getMessage());
                    skipped++;
                }
            }
            
            System.out.println("Import complete: " + imported + " requests imported, " + skipped + " skipped");
        } catch (IOException e) {
            System.err.println("Error reading file: " + e.getMessage());
            e.printStackTrace();
        }
        
        return imported;
    }
}package services;

import dao.RequestDAO;
import dao.WasteRecordDAO;
import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

/**
 * Service class for managing requests.
 * Uses database for all operations via RequestDAO and WasteRecordDAO.
 */
public class RequestService {
    
    /**
     * Creates a new request.
     * First saves to .txt file, then automatically imports to database.
     * @param requesterUsername The username of the requester
     * @param barangay The barangay
     * @param requestType The type of request
     * @param location The location of the request
     * @param description The request description
     * @param numSacks Number of sacks of waste
     * @param wasteType Type of waste (Malata, Di Malata, Magagamit Pa, Hazardous)
     * @return true if successful, false otherwise
     */
    public static boolean createRequest(String requesterUsername, String barangay, 
                                        String requestType, String location, String description, int numSacks, String wasteType) {
        // Step 1: Save to .txt file first
            String timestamp = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date());
            String locationStr = (location == null || location.isEmpty()) ? "N/A" : location;
        String targetRole = "Barangay Captain"; // Default target role for new requests
        
        // Determine which file to save to based on target role
        String fileName = "data/requestform.txt"; // Default file
        if ("Barangay Captain".equals(targetRole)) {
            fileName = "data/requestformbarangaycaptain.txt";
        } else if ("City Officer".equals(targetRole)) {
            fileName = "data/requestformcityoffer.txt";
        } else if ("Garbage Collector".equals(targetRole)) {
            fileName = "data/requestformgarbagecollector.txt";
        } else if ("Waste Manager".equals(targetRole)) {
            fileName = "data/requestformwastemanagement.txt";
        }
        
        File txtFile = new File(fileName);
        
        try {
            // Ensure data directory exists
            txtFile.getParentFile().mkdirs();
            
            // Append to .txt file (pipe-delimited format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status)
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile, true))) {
                // Check if file is empty or doesn't exist, write header
                if (!txtFile.exists() || txtFile.length() == 0) {
                    writer.write("# Requests for " + targetRole);
                    writer.newLine();
                    writer.write("# Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status");
                    writer.newLine();
                    writer.newLine();
                }
                
                // Write request data (id will be generated by database, use 0 as placeholder)
                writer.write("0|" + timestamp + "|" + requesterUsername + "|" + barangay + "|" + 
                           requestType + "|" + locationStr + "|" + (description != null ? description : "") + "|" + 
                           numSacks + "|" + (wasteType != null ? wasteType : "") + "|Pending");
                writer.newLine();
                writer.flush();
            }
            
            // Step 2: Automatically import from .txt to database
            int id = RequestDAO.createRequest(timestamp, requesterUsername, barangay, requestType, 
                                            locationStr, description, numSacks, wasteType, 
                                            "Pending", targetRole);
            return id > 0;
            
        } catch (IOException e) {
            System.err.println("Error writing to .txt file: " + e.getMessage());
            e.printStackTrace();
            // Still try to save to database even if .txt write fails
            try {
                int id = RequestDAO.createRequest(timestamp, requesterUsername, barangay, requestType, 
                                                locationStr, description, numSacks, wasteType, 
                                                "Pending", targetRole);
                return id > 0;
            } catch (SQLException sqlEx) {
                System.err.println("Error creating request: " + sqlEx.getMessage());
                sqlEx.printStackTrace();
                return false;
            }
        } catch (SQLException e) {
            System.err.println("Error creating request: " + e.getMessage());
            e.printStackTrace();
            return false;
        }
    }
    
    /**
     * Gets all requests from requestform.txt filtered by barangay.
     * @param barangay The barangay to filter by
     * @return List of requests {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
     */
    public static List<Object[]> getBarangayRequests(String barangay) {
        List<Object[]> result = new ArrayList<>();
        try {
            List<Object[]> requests = RequestDAO.getRequestsByBarangay(barangay);
            
            for (Object[] req : requests) {
                // Database format: {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
                // Service format: {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
                
                String status = (String) req[9];
                String targetRole = (String) req[10];
                
                // Only include pending requests targeted at Barangay Captain
                if ("Pending".equals(status) && ("Barangay Captain".equals(targetRole) || targetRole == null)) {
                    result.add(new Object[]{
                        req[0],  // id
                        req[1],  // timestamp
                        req[2],  // requester
                        req[3],  // barangay
                        req[4],  // type (request_type)
                        req[5],  // location
                        req[6],  // description
                        req[7],  // numSacks (num_sacks)
                        req[8],  // wasteType (waste_type)
                        req[9]   // status
                    });
                }
            }
        } catch (SQLException e) {
            System.err.println("Error loading requests: " + e.getMessage());
        }
        
        return result;
    }
    
    /**
     * Forwards a request to Barangay Captain.
     * @param requestData The request data {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
     * @return true if successful, false otherwise
     */
    public static boolean forwardToBarangayCaptain(Object[] requestData) {
        // This is already handled in createRequest - new requests go to Barangay Captain
        return true;
    }
    
    /**
     * Gets all requests for Barangay Captain.
     * @return List of requests {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
     */
    public static List<Object[]> getBarangayCaptainRequests() {
        List<Object[]> result = new ArrayList<>();
        try {
            List<Object[]> requests = RequestDAO.getRequestsByTargetRole("Barangay Captain");
            
            for (Object[] req : requests) {
                result.add(convertToServiceFormat(req));
            }
        } catch (SQLException e) {
            System.err.println("Error loading Barangay Captain requests: " + e.getMessage());
        }
        
        return result;
    }
    
    /**
     * Updates the status of a request for Barangay Captain.
     * @param requestId The request ID
     * @param timestamp The request timestamp (for unique identification)
     * @param newStatus The new status (e.g., "Approved", "Rejected", "Completed")
     * @return true if successful, false otherwise
     */
    public static boolean updateBarangayCaptainRequestStatus(int requestId, String timestamp, String newStatus) {
        try {
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null) {
                return false;
            }
            
            // Verify timestamp matches
            if (!timestamp.equals(request[1])) {
                return false;
            }
            
            // If rejected, delete the request from database and file
            if (newStatus != null && newStatus.toLowerCase().contains("rejected")) {
                boolean dbDeleted = RequestDAO.deleteRequest(requestId);
                if (dbDeleted) {
                    // Remove from Barangay Captain file (use timestamp from database request for exact match)
                    String dbTimestamp = (String) request[1];
                    removeRequestFromBarangayCaptainFile(requestId, dbTimestamp);
                }
                return dbDeleted;
            }
            
            return RequestDAO.updateRequestStatus(requestId, newStatus);
        } catch (SQLException e) {
            System.err.println("Error updating Barangay Captain request: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Forwards an approved request from Barangay Captain to City Officer.
     * @param requestData The request data {id, timestamp, requester, barangay, area, type, description, numSacks, wasteType, status}
     * @return true if successful, false otherwise
     */
    public static boolean forwardToCityOfficer(Object[] requestData) {
        try {
            int requestId = (Integer) requestData[0];
            String timestamp = (String) requestData[1];
            
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null || !timestamp.equals(request[1])) {
                return false;
            }
            
            // Update database
            boolean dbSuccess = RequestDAO.updateRequestTargetRole(requestId, "City Officer") &&
                   RequestDAO.updateRequestStatus(requestId, "Pending (City Officer)");
            
            if (dbSuccess) {
                // Remove from Barangay Captain file (use timestamp from database request for exact match)
                String dbTimestamp = (String) request[1];
                removeRequestFromBarangayCaptainFile(requestId, dbTimestamp);
                
                // Add to City Officer file
                addRequestToCityOfficerFile(request);
            }
            
            return dbSuccess;
        } catch (SQLException e) {
            System.err.println("Error forwarding request to City Officer: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Forwards a new request directly from Barangay Captain's view to City Officer.
     * This is used when the Captain approves a Barangay Member request in the
     * generic "View Requests" panel and we want it to go straight to City Officer.
     */
    public static boolean forwardFromMemberToCityOfficer(String barangay, Object[] requestData) {
        try {
            int requestId = (Integer) requestData[0];
            String timestamp = (String) requestData[1];
            
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null || !timestamp.equals(request[1])) {
                return false;
            }
            
            // Update database
            boolean dbSuccess = RequestDAO.updateRequestTargetRole(requestId, "City Officer") &&
                   RequestDAO.updateRequestStatus(requestId, "Pending (City Officer)");
            
            if (dbSuccess) {
                // Remove from Barangay Captain file (use timestamp from database request for exact match)
                String dbTimestamp = (String) request[1];
                removeRequestFromBarangayCaptainFile(requestId, dbTimestamp);
                
                // Add to City Officer file
                addRequestToCityOfficerFile(request);
            }
            
            return dbSuccess;
        } catch (SQLException e) {
            System.err.println("Error forwarding member request directly to City Officer: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Gets all requests for City Officer.
     * @return List of requests {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
     */
    public static List<Object[]> getCityOfficerRequests() {
        List<Object[]> result = new ArrayList<>();
        try {
            List<Object[]> requests = RequestDAO.getRequestsByTargetRole("City Officer");
            
            for (Object[] req : requests) {
                result.add(convertToServiceFormat(req));
            }
        } catch (SQLException e) {
            System.err.println("Error loading City Officer requests: " + e.getMessage());
        }
        
        return result;
    }
    
    /**
     * Updates the status of a request for City Officer.
     * @param requestId The request ID
     * @param timestamp The request timestamp
     * @param newStatus New status text
     */
    public static boolean updateCityOfficerRequestStatus(int requestId, String timestamp, String newStatus) {
        try {
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null || !timestamp.equals(request[1])) {
                return false;
            }
            
            // If rejected, delete the request from database and file
            if (newStatus != null && newStatus.toLowerCase().contains("rejected")) {
                boolean dbDeleted = RequestDAO.deleteRequest(requestId);
                if (dbDeleted) {
                    // Remove from City Officer file (use timestamp from database request for exact match)
                    String dbTimestamp = (String) request[1];
                    removeRequestFromCityOfficerFile(requestId, dbTimestamp);
                }
                return dbDeleted;
            }
            
            return RequestDAO.updateRequestStatus(requestId, newStatus);
        } catch (SQLException e) {
            System.err.println("Error updating City Officer request: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Forwards an approved request from City Officer to Garbage Collector.
     * @param requestData The request data
     * @return true if successful, false otherwise
     */
    public static boolean forwardToGarbageCollector(Object[] requestData) {
        try {
            int requestId = (Integer) requestData[0];
            String timestamp = (String) requestData[1];
            
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null || !timestamp.equals(request[1])) {
                return false;
            }
            
            // Update database
            boolean dbSuccess = RequestDAO.updateRequestTargetRole(requestId, "Garbage Collector") &&
                   RequestDAO.updateRequestStatus(requestId, "Pending (Garbage Collector)");
            
            if (dbSuccess) {
                // Remove from City Officer file (use timestamp from database request for exact match)
                String dbTimestamp = (String) request[1];
                removeRequestFromCityOfficerFile(requestId, dbTimestamp);
                
                // Add to Garbage Collector file
                addRequestToGarbageCollectorFile(request);
            }
            
            return dbSuccess;
        } catch (SQLException e) {
            System.err.println("Error forwarding request to Garbage Collector: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Gets all requests for Garbage Collector.
     * @return List of requests {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
     */
    public static List<Object[]> getGarbageCollectorRequests() {
        List<Object[]> result = new ArrayList<>();
        try {
            List<Object[]> requests = RequestDAO.getRequestsByTargetRole("Garbage Collector");
            
            for (Object[] req : requests) {
                result.add(convertToServiceFormat(req));
            }
        } catch (SQLException e) {
            System.err.println("Error loading Garbage Collector requests: " + e.getMessage());
        }
        
        return result;
    }
    
    /**
     * Updates the status of a request for Garbage Collector.
     */
    public static boolean updateGarbageCollectorRequestStatus(int requestId, String timestamp, String newStatus) {
        try {
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null || !timestamp.equals(request[1])) {
                return false;
            }
            
            // If rejected, delete the request from database and file
            if (newStatus != null && newStatus.toLowerCase().contains("rejected")) {
                boolean dbDeleted = RequestDAO.deleteRequest(requestId);
                if (dbDeleted) {
                    // Remove from Garbage Collector file (use timestamp from database request for exact match)
                    String dbTimestamp = (String) request[1];
                    removeRequestFromGarbageCollectorFile(requestId, dbTimestamp);
                }
                return dbDeleted;
            }
            
            String oldStatus = (String) request[9];
            
            // Update status
            boolean success = RequestDAO.updateRequestStatus(requestId, newStatus);
            
            // If the request has just been marked as completed by the Garbage Collector,
            // automatically create a corresponding Waste Log entry and remove from file
            if (success && !"Completed by Garbage Collector".equals(oldStatus)
                    && "Completed by Garbage Collector".equals(newStatus)) {
                try {
                    String fullTimestamp = (String) request[1];
                    String barangay = (String) request[3];
                    String location = (String) request[5];
                    if (location == null || location.equals("N/A")) {
                        location = barangay;
                    }
                    int numSacks = (Integer) request[7];
                    String wasteType = (String) request[8];
                    String description = (String) request[6];
                    
                    // Use the date portion of the timestamp (yyyy-MM-dd)
                    String dateOnly = fullTimestamp.split(" ")[0];
                    
                    // Extract weight from description (format: "Weight: X.XX kg | ...")
                    double weight = numSacks; // Default fallback to numSacks if weight not found
                    if (description != null && description.contains("Weight:")) {
                        try {
                            int weightIndex = description.indexOf("Weight:");
                            if (weightIndex != -1) {
                                int start = weightIndex + 7; // Skip "Weight:"
                                int end = description.indexOf(" kg", start);
                                if (end != -1) {
                                    String weightStr = description.substring(start, end).trim();
                                    weight = Double.parseDouble(weightStr);
                                }
                            }
                        } catch (Exception e) {
                            System.err.println("Error extracting weight from description, using numSacks as fallback: " + e.getMessage());
                            // Keep default weight = numSacks
                        }
                    }
                    
                    // Save to waste records (database and managewasterecord.txt file)
                    saveToManageWasteRecord(dateOnly, location, weight, wasteType, barangay);
                    
                    // Remove from Garbage Collector file since it's completed
                    String dbTimestamp = (String) request[1];
                    removeRequestFromGarbageCollectorFile(requestId, dbTimestamp);
                } catch (Exception e) {
                    System.err.println("Error auto-logging completed collection: " + e.getMessage());
                }
            }
            
            return success;
        } catch (SQLException e) {
            System.err.println("Error updating Garbage Collector request: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Updates the status of a request.
     * @param barangay The barangay
     * @param requestId The request ID
     * @param timestamp The request timestamp (for unique identification)
     * @param newStatus The new status (e.g., "Approved", "Rejected", "Completed")
     * @return true if successful, false otherwise
     */
    public static boolean updateRequestStatus(String barangay, int requestId, String timestamp, String newStatus) {
        try {
            Object[] request = RequestDAO.getRequestById(requestId);
            if (request == null || !timestamp.equals(request[1])) {
                return false;
            }
            
            // If rejected, delete the request from database and file
            if (newStatus != null && newStatus.toLowerCase().contains("rejected")) {
                boolean dbDeleted = RequestDAO.deleteRequest(requestId);
                if (dbDeleted) {
                    // Determine which file to remove from based on target_role
                    // Use timestamp from database request for exact match
                    String dbTimestamp = (String) request[1];
                    String targetRole = (String) request[10]; // target_role is at index 10
                    if ("Barangay Captain".equals(targetRole) || targetRole == null) {
                        removeRequestFromBarangayCaptainFile(requestId, dbTimestamp);
                    } else if ("City Officer".equals(targetRole)) {
                        removeRequestFromCityOfficerFile(requestId, dbTimestamp);
                    } else if ("Waste Manager".equals(targetRole)) {
                        removeRequestFromWasteManagerFile(requestId, dbTimestamp);
                    } else if ("Garbage Collector".equals(targetRole)) {
                        removeRequestFromGarbageCollectorFile(requestId, dbTimestamp);
                    }
                }
                return dbDeleted;
            }
            
            return RequestDAO.updateRequestStatus(requestId, newStatus);
        } catch (SQLException e) {
            System.err.println("Error updating request: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * Converts database format to service format.
     * Database format: {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
     * Service format: {id, timestamp, requester, barangay, type, location, description, numSacks, wasteType, status}
     */
    private static Object[] convertToServiceFormat(Object[] dbRequest) {
        return new Object[]{
            dbRequest[0],  // id
            dbRequest[1],  // timestamp
            dbRequest[2],  // requester
            dbRequest[3],  // barangay
            dbRequest[4],  // type (request_type)
            dbRequest[5],  // location
            dbRequest[6],  // description
            dbRequest[7],  // numSacks (num_sacks)
            dbRequest[8],  // wasteType (waste_type)
            dbRequest[9]   // status
        };
    }
    
    /**
     * Saves a completed collection record to waste records.
     * Saves to both database and managewasterecord.txt file.
     * @param date The date of collection
     * @param location The location of collection
     * @param weight The weight in kg
     * @param wasteType The type of waste
     * @param barangay The barangay (stored but not shown in GUI)
     */
    public static void saveToManageWasteRecord(String date, String location, double weight, String wasteType, String barangay) {
        try {
            // Step 1: Save to database first to get the generated ID
            int newId = WasteRecordDAO.createWasteRecord("Garbage Collector", date, location, weight, wasteType, barangay);
            
            // Step 2: Save to managewasterecord.txt file
            if (newId > 0) {
                File txtFile = new File("data/managewasterecord.txt");
                
                try {
                    // Ensure data directory exists
                    txtFile.getParentFile().mkdirs();
                    
                    // Append to .txt file (format: id|date|location|weight|type|barangay)
                    try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile, true))) {
                        // Check if file is empty or doesn't exist, write header
                        if (!txtFile.exists() || txtFile.length() == 0) {
                            writer.write("# Waste Logs Records Management");
                            writer.newLine();
                            writer.write("# Format: id|date|location|weight|type|barangay");
                            writer.newLine();
                            writer.newLine();
                        }
                        
                        // Write waste record data
                        String locationStr = (location == null || location.isEmpty()) ? "N/A" : location;
                        String wasteTypeStr = (wasteType == null) ? "" : wasteType;
                        String barangayStr = (barangay == null) ? "" : barangay;
                        // Format weight to preserve full precision (use 2 decimal places)
                        String weightStr = String.format("%.2f", weight);
                        
                        writer.write(newId + "|" + date + "|" + locationStr + "|" + weightStr + "|" + wasteTypeStr + "|" + barangayStr);
                        writer.newLine();
                        writer.flush();
                    }
                } catch (IOException e) {
                    System.err.println("Error writing to managewasterecord.txt file: " + e.getMessage());
                    e.printStackTrace();
                    // Continue - database save was successful
                }
            }
        } catch (SQLException e) {
            System.err.println("Error saving to waste records: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Gets all records from waste records (for manage waste records view).
     * Reads from database (which now includes barangay column).
     * Returns {id, date, location, weight, type, barangay}
     * @return List of records {id, date, location, weight, type, barangay}
     */
    public static List<Object[]> getManageWasteRecords() {
        List<Object[]> result = new ArrayList<>();
        
        try {
            // Read from database (now includes barangay column)
            List<Object[]> records = WasteRecordDAO.getWasteRecordsByRole("Garbage Collector");
            for (Object[] record : records) {
                // Database format: {id, role, date, area, weight, type, barangay}
                // Service format: {id, date, location, weight, type, barangay}
                String location = (String) record[3]; // area
                String barangay = record.length >= 7 && record[6] != null ? (String) record[6] : "N/A";
                
                result.add(new Object[]{
                    record[0],      // id
                    record[2],      // date
                    location,       // location (from area)
                    record[4],      // weight
                    record[5],      // type
                    barangay        // barangay (from database)
                });
            }
        } catch (SQLException e) {
            System.err.println("Error loading from database: " + e.getMessage());
            // Fallback to file if database read fails
            File txtFile = new File("data/managewasterecord.txt");
            if (txtFile.exists()) {
                try (BufferedReader reader = new BufferedReader(new FileReader(txtFile))) {
                    String line;
                    while ((line = reader.readLine()) != null) {
                        line = line.trim();
                        // Skip empty lines and comments
                        if (line.isEmpty() || line.startsWith("#")) {
                            continue;
                        }
                        
                        // Parse pipe-delimited format: id|date|location|weight|type|barangay
                        String[] parts = line.split("\\|");
                        if (parts.length >= 6) {
                            try {
                                int id = Integer.parseInt(parts[0].trim());
                                String date = parts[1].trim();
                                String location = parts[2].trim();
                                double weight = Double.parseDouble(parts[3].trim());
                                String type = parts[4].trim();
                                String barangay = parts[5].trim();
                                
                                result.add(new Object[]{
                                    id,         // id
                                    date,       // date
                                    location,   // location
                                    weight,     // weight
                                    type,       // type
                                    barangay    // barangay (from file)
                                });
                            } catch (NumberFormatException ex) {
                                System.err.println("Error parsing line in managewasterecord.txt: " + line);
                            }
                        }
                    }
                } catch (IOException ioE) {
                    System.err.println("Error reading managewasterecord.txt: " + ioE.getMessage());
                }
            }
        }
        
        return result;
    }
    
    /**
     * Saves all records to waste records with barangay.
     * Saves to both database and managewasterecord.txt file.
     * @param records List of records {id, date, location, weight, type, barangay} from GUI
     */
    public static void saveManageWasteRecordsWithBarangay(List<Object[]> records) {
        File txtFile = new File("data/managewasterecord.txt");
        
        try {
            // Step 1: Delete all existing Garbage Collector records from database
            List<Object[]> existing = WasteRecordDAO.getWasteRecordsByRole("Garbage Collector");
            for (Object[] rec : existing) {
                WasteRecordDAO.deleteWasteRecord((Integer) rec[0]);
            }
            
            // Step 2: Save new records to database and get new IDs
            List<Object[]> recordsWithIds = new ArrayList<>();
            for (Object[] record : records) {
                // Format: {id, date, location, weight, type, barangay}
                String date = (String) record[1];
                String location = (String) record[2];
                // Handle weight - could be Number, String, or Double
                double weight;
                if (record[3] instanceof Number) {
                    weight = ((Number) record[3]).doubleValue();
                } else if (record[3] instanceof String) {
                    try {
                        weight = Double.parseDouble(((String) record[3]).trim());
                    } catch (NumberFormatException e) {
                        System.err.println("Invalid weight value: " + record[3]);
                        continue; // Skip this record
                    }
                } else {
                    System.err.println("Invalid weight type: " + record[3].getClass());
                    continue; // Skip this record
                }
                String type = (String) record[4];
                String barangay = record.length >= 6 && record[5] != null ? (String) record[5] : "N/A";
                
                int newId = WasteRecordDAO.createWasteRecord("Garbage Collector", date, location, weight, type, barangay);
                if (newId > 0) {
                    recordsWithIds.add(new Object[]{
                        newId, date, location, weight, type, barangay
                    });
                }
            }
            
            // Step 3: Save to managewasterecord.txt file (overwrite entire file)
            try {
                txtFile.getParentFile().mkdirs();
                try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile, false))) {
                    // Write header
                    writer.write("# Waste Logs Records Management");
                    writer.newLine();
                    writer.write("# Format: id|date|location|weight|type|barangay");
                    writer.newLine();
                    writer.newLine();
                    
                    // Write all records
                    for (Object[] record : recordsWithIds) {
                        int id = (Integer) record[0];
                        String date = (String) record[1];
                        String location = (String) record[2];
                        double weight = ((Number) record[3]).doubleValue();
                        String type = (String) record[4];
                        String barangay = (String) record[5];
                        
                        String locationStr = (location == null || location.isEmpty()) ? "N/A" : location;
                        String wasteTypeStr = (type == null) ? "" : type;
                        String barangayStr = (barangay == null || barangay.isEmpty()) ? "N/A" : barangay;
                        // Format weight to preserve full precision (use 2 decimal places)
                        String weightStr = String.format("%.2f", weight);
                        
                        writer.write(id + "|" + date + "|" + locationStr + "|" + weightStr + "|" + wasteTypeStr + "|" + barangayStr);
                        writer.newLine();
                    }
                    writer.flush();
                }
            } catch (IOException e) {
                System.err.println("Error writing to managewasterecord.txt file: " + e.getMessage());
                e.printStackTrace();
            }
        } catch (SQLException e) {
            System.err.println("Error saving waste records: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Saves all records to waste records.
     * Reads existing records to preserve barangay data, then saves with barangay.
     * @param records List of records {id, date, location, weight, type} from GUI
     */
    public static void saveManageWasteRecords(List<Object[]> records) {
        // Same as saveManageWasteRecordsWithBarangay since we use location/area
        saveManageWasteRecordsWithBarangay(records);
    }
    
    /**
     * Deletes a record from waste records by ID.
     * Deletes from both database and managewasterecord.txt file.
     * @param id The record ID to delete
     */
    public static void deleteManageWasteRecord(int id) {
        try {
            // Step 1: Delete from database first
            boolean dbDeleted = WasteRecordDAO.deleteWasteRecord(id);
            if (!dbDeleted) {
                System.err.println("Warning: Record ID " + id + " not found in database");
            }
            
            // Step 2: Delete from managewasterecord.txt file by reading directly from file
            File txtFile = new File("data/managewasterecord.txt");
            if (txtFile.exists()) {
                List<String> remainingLines = new ArrayList<>();
                boolean found = false;
                
                // Read all lines from file
                try (BufferedReader reader = new BufferedReader(new FileReader(txtFile))) {
                    String line;
                    while ((line = reader.readLine()) != null) {
                        // Keep header lines
                        if (line.trim().isEmpty() || line.startsWith("#")) {
                            remainingLines.add(line);
                            continue;
                        }
                        
                        // Parse pipe-delimited format: id|date|location|weight|type|barangay
                        String[] parts = line.split("\\|");
                        if (parts.length >= 1) {
                            try {
                                int fileId = Integer.parseInt(parts[0].trim());
                                // Skip the line if ID matches
                                if (fileId == id) {
                                    found = true;
                                    continue; // Don't add this line
                                }
                            } catch (NumberFormatException ex) {
                                // If ID parsing fails, keep the line
                            }
                        }
                        
                        // Add line if ID doesn't match
                        remainingLines.add(line);
                    }
                } catch (IOException e) {
                    System.err.println("Error reading managewasterecord.txt file: " + e.getMessage());
                    e.printStackTrace();
                    return; // Exit if we can't read the file
                }
                
                // Rewrite the file with remaining lines
                try {
                    txtFile.getParentFile().mkdirs();
                    try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile, false))) {
                        for (String line : remainingLines) {
                            writer.write(line);
                            writer.newLine();
                        }
                        writer.flush();
                    }
                    
                    if (found || dbDeleted) {
                        System.out.println("Successfully deleted record ID " + id + " from both database and file");
                    }
                } catch (IOException e) {
                    System.err.println("Error updating managewasterecord.txt file: " + e.getMessage());
                    e.printStackTrace();
                }
            } else {
                // File doesn't exist, but database delete succeeded
                if (dbDeleted) {
                    System.out.println("Record ID " + id + " deleted from database (file doesn't exist)");
                }
            }
        } catch (SQLException e) {
            System.err.println("Error deleting waste record from database: " + e.getMessage());
            e.printStackTrace();
        }
    }

    /**
     * Returns a lightweight summary of all requests for reporting purposes.
     * Format: {id, timestamp, requester, barangay, type, status}
     */
    public static java.util.List<Object[]> getAllRequestsSummary() {
        java.util.List<Object[]> result = new java.util.ArrayList<>();
        try {
            java.util.List<Object[]> all = RequestDAO.getAllRequests();
            for (Object[] req : all) {
                // {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
                result.add(new Object[]{
                    req[0], // id
                    req[1], // timestamp
                    req[2], // requester
                    req[3], // barangay
                    req[4], // type
                    req[9]  // status
                });
            }
        } catch (SQLException e) {
            System.err.println("Error loading requests summary: " + e.getMessage());
        }
        return result;
    }

    /**
     * Exports all requests to a CSV file.
     * Columns: id,timestamp,requester,barangay,request_type,location,description,num_sacks,waste_type,status,target_role
     *
     * @param file target file (CSV or .txt)
     * @return true if successful, false otherwise
     */
    public static boolean exportRequestsToCsv(File file) {
        if (file == null) return false;
        try (BufferedWriter writer = new BufferedWriter(new FileWriter(file))) {
            // Header
            writer.write("id,timestamp,requester,barangay,request_type,location,description,num_sacks,waste_type,status,target_role");
            writer.newLine();

            java.util.List<Object[]> all = RequestDAO.getAllRequests();
            for (Object[] req : all) {
                // Escape commas by wrapping text in quotes if needed
                String line = String.format("%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s",
                        safeCsv(req[0]),
                        safeCsv(req[1]),
                        safeCsv(req[2]),
                        safeCsv(req[3]),
                        safeCsv(req[4]),
                        safeCsv(req[5]),
                        safeCsv(req[6]),
                        safeCsv(req[7]),
                        safeCsv(req[8]),
                        safeCsv(req[9]),
                        safeCsv(req[10])
                );
                writer.write(line);
                writer.newLine();
            }
            writer.flush();
            return true;
        } catch (IOException | SQLException e) {
            System.err.println("Error exporting requests to CSV: " + e.getMessage());
            e.printStackTrace();
            return false;
        }
    }

    // Helper for safe CSV cell formatting
    private static String safeCsv(Object value) {
        if (value == null) return "";
        String text = String.valueOf(value);
        // If contains comma or quote, wrap in quotes and escape internal quotes
        if (text.contains(",") || text.contains("\"") || text.contains("\n")) {
            text = text.replace("\"", "\"\"");
            return "\"" + text + "\"";
        }
        return text;
    }

    /**
     * Removes a request from the requestformbarangaycaptain.txt file.
     * @param requestId The request ID (not used for matching, file has placeholder 0)
     * @param timestamp The request timestamp for identification (unique identifier)
     */
    private static void removeRequestFromBarangayCaptainFile(int requestId, String timestamp) {
        File txtFile = new File("data/requestformbarangaycaptain.txt");
        
        if (!txtFile.exists()) {
            return; // File doesn't exist, nothing to do
        }
        
        try {
            // Read all lines from file
            List<String> lines = new ArrayList<>();
            boolean found = false;
            
            try (BufferedReader reader = new BufferedReader(new FileReader(txtFile))) {
                String line;
                while ((line = reader.readLine()) != null) {
                    // Skip the line if it matches the request to remove (match by timestamp since file has placeholder ID 0)
                    if (!line.trim().isEmpty() && !line.startsWith("#")) {
                        String[] parts = line.split("\\|", -1); // Use -1 to preserve empty strings
                        // Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                        if (parts.length >= 2) {
                            String fileTimestamp = parts[1].trim();
                            String trimmedTimestamp = timestamp.trim();
                            // Match by timestamp only (file has placeholder ID 0, but database has real ID)
                            if (fileTimestamp.equals(trimmedTimestamp)) {
                                // Skip this line (don't add it to lines list)
                                found = true;
                                System.out.println("Removing request from barangay captain file: timestamp=" + trimmedTimestamp);
                                continue;
                            }
                        }
                    }
                    
                    lines.add(line);
                }
            }
            
            // Write updated content back to file only if we found a match
            if (found) {
                try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile))) {
                    for (String line : lines) {
                        writer.write(line);
                        writer.newLine();
                    }
                    writer.flush();
                }
                System.out.println("Successfully removed request from requestformbarangaycaptain.txt");
            } else {
                System.err.println("Warning: Request with timestamp '" + timestamp.trim() + "' not found in requestformbarangaycaptain.txt file");
            }
            
        } catch (IOException e) {
            System.err.println("Error removing request from requestformbarangaycaptain.txt file: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Adds a request to the requestformcityoffer.txt file.
     * @param request The request data from database {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
     */
    private static void addRequestToCityOfficerFile(Object[] request) {
        File txtFile = new File("data/requestformcityoffer.txt");
        
        try {
            // Ensure data directory exists
            txtFile.getParentFile().mkdirs();
            
            // Database format: {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
            int id = (Integer) request[0];
            String timestamp = (String) request[1];
            String requester = (String) request[2];
            String barangay = (String) request[3];
            String requestType = (String) request[4];
            String location = (String) request[5];
            String description = (String) request[6];
            int numSacks = (Integer) request[7];
            String wasteType = (String) request[8];
            String status = "Pending (City Officer)"; // Use the new status
            
            String locationStr = (location == null || location.isEmpty()) ? "N/A" : location;
            String descriptionStr = (description == null) ? "" : description;
            String wasteTypeStr = (wasteType == null) ? "" : wasteType;
            
            // Append to .txt file
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile, true))) {
                // Check if file is empty or doesn't exist, write header
                if (!txtFile.exists() || txtFile.length() == 0) {
                    writer.write("# Requests for City Officer (Approved by Barangay Captain) - All Request Types");
                    writer.newLine();
                    writer.write("# Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status");
                    writer.newLine();
                    writer.write("# Note: numSacks and wasteType are only used for Waste Collection requests");
                    writer.newLine();
                    writer.newLine();
                }
                
                // Write request data
                // Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                writer.write(id + "|" + timestamp + "|" + requester + "|" + barangay + "|" + 
                           requestType + "|" + locationStr + "|" + descriptionStr + "|" + 
                           numSacks + "|" + wasteTypeStr + "|" + status);
                writer.newLine();
                writer.flush();
            }
            
        } catch (IOException e) {
            System.err.println("Error adding request to requestformcityoffer.txt file: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Removes a request from the requestformcityoffer.txt file.
     * @param requestId The request ID (used for matching - file should have real ID when forwarded)
     * @param timestamp The request timestamp for identification
     */
    private static void removeRequestFromCityOfficerFile(int requestId, String timestamp) {
        File txtFile = new File("data/requestformcityoffer.txt");
        
        if (!txtFile.exists()) {
            return; // File doesn't exist, nothing to do
        }
        
        try {
            // Read all lines from file
            List<String> lines = new ArrayList<>();
            
            try (BufferedReader reader = new BufferedReader(new FileReader(txtFile))) {
                String line;
                while ((line = reader.readLine()) != null) {
                    // Skip the line if it matches the request to remove
                    if (!line.trim().isEmpty() && !line.startsWith("#")) {
                        String[] parts = line.split("\\|");
                        // Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                        if (parts.length >= 2) {
                            try {
                                int fileId = Integer.parseInt(parts[0].trim());
                                String fileTimestamp = parts[1].trim();
                                // Match by both ID and timestamp (file should have real ID when forwarded)
                                if (fileId == requestId && fileTimestamp.equals(timestamp)) {
                                    // Skip this line (don't add it to lines list)
                                    continue;
                                }
                            } catch (NumberFormatException e) {
                                // If ID parsing fails, try matching by timestamp only
                                String fileTimestamp = parts[1].trim();
                                if (fileTimestamp.equals(timestamp)) {
                                    continue;
                                }
                            }
                        }
                    }
                    
                    lines.add(line);
                }
            }
            
            // Write updated content back to file
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile))) {
                for (String line : lines) {
                    writer.write(line);
                    writer.newLine();
                }
                writer.flush();
            }
            
        } catch (IOException e) {
            System.err.println("Error removing request from requestformcityoffer.txt file: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Removes a request from the requestformwastemanagement.txt file.
     * @param requestId The request ID (used for matching - file should have real ID when forwarded)
     * @param timestamp The request timestamp for identification
     */
    private static void removeRequestFromWasteManagerFile(int requestId, String timestamp) {
        File txtFile = new File("data/requestformwastemanagement.txt");
        
        if (!txtFile.exists()) {
            return; // File doesn't exist, nothing to do
        }
        
        try {
            // Read all lines from file
            List<String> lines = new ArrayList<>();
            
            try (BufferedReader reader = new BufferedReader(new FileReader(txtFile))) {
                String line;
                while ((line = reader.readLine()) != null) {
                    // Skip the line if it matches the request to remove
                    if (!line.trim().isEmpty() && !line.startsWith("#")) {
                        String[] parts = line.split("\\|");
                        // Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                        if (parts.length >= 2) {
                            try {
                                int fileId = Integer.parseInt(parts[0].trim());
                                String fileTimestamp = parts[1].trim();
                                // Match by both ID and timestamp (file should have real ID when forwarded)
                                if (fileId == requestId && fileTimestamp.equals(timestamp)) {
                                    // Skip this line (don't add it to lines list)
                                    continue;
                                }
                            } catch (NumberFormatException e) {
                                // If ID parsing fails, try matching by timestamp only
                                String fileTimestamp = parts[1].trim();
                                if (fileTimestamp.equals(timestamp)) {
                                    continue;
                                }
                            }
                        }
                    }
                    
                    lines.add(line);
                }
            }
            
            // Write updated content back to file
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile))) {
                for (String line : lines) {
                    writer.write(line);
                    writer.newLine();
                }
                writer.flush();
            }
            
        } catch (IOException e) {
            System.err.println("Error removing request from requestformwastemanagement.txt file: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Adds a request to the requestformgarbagecollector.txt file.
     * @param request The request data from database {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
     */
    private static void addRequestToGarbageCollectorFile(Object[] request) {
        File txtFile = new File("data/requestformgarbagecollector.txt");
        
        try {
            // Ensure data directory exists
            txtFile.getParentFile().mkdirs();
            
            // Database format: {id, timestamp, requester, barangay, request_type, location, description, num_sacks, waste_type, status, target_role}
            int id = (Integer) request[0];
            String timestamp = (String) request[1];
            String requester = (String) request[2];
            String barangay = (String) request[3];
            String requestType = (String) request[4];
            String location = (String) request[5];
            String description = (String) request[6];
            int numSacks = (Integer) request[7];
            String wasteType = (String) request[8];
            String status = "Pending (Garbage Collector)"; // Use the new status
            
            String locationStr = (location == null || location.isEmpty()) ? "N/A" : location;
            String descriptionStr = (description == null) ? "" : description;
            String wasteTypeStr = (wasteType == null) ? "" : wasteType;
            
            // Append to .txt file
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile, true))) {
                // Check if file is empty or doesn't exist, write header
                if (!txtFile.exists() || txtFile.length() == 0) {
                    writer.write("# Requests for Garbage Collector (Approved by City Officer) - All Request Types");
                    writer.newLine();
                    writer.write("# Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status");
                    writer.newLine();
                    writer.write("# Note: numSacks and wasteType are only used for Waste Collection requests");
                    writer.newLine();
                    writer.newLine();
                }
                
                // Write request data
                // Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                writer.write(id + "|" + timestamp + "|" + requester + "|" + barangay + "|" + 
                           requestType + "|" + locationStr + "|" + descriptionStr + "|" + 
                           numSacks + "|" + wasteTypeStr + "|" + status);
                writer.newLine();
                writer.flush();
            }
            
        } catch (IOException e) {
            System.err.println("Error adding request to requestformgarbagecollector.txt file: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Removes a request from the requestformgarbagecollector.txt file.
     * @param requestId The request ID (used for matching - file should have real ID when forwarded)
     * @param timestamp The request timestamp for identification
     */
    private static void removeRequestFromGarbageCollectorFile(int requestId, String timestamp) {
        File txtFile = new File("data/requestformgarbagecollector.txt");
        
        if (!txtFile.exists()) {
            return; // File doesn't exist, nothing to do
        }
        
        try {
            // Read all lines from file
            List<String> lines = new ArrayList<>();
            
            try (BufferedReader reader = new BufferedReader(new FileReader(txtFile))) {
                String line;
                while ((line = reader.readLine()) != null) {
                    // Skip the line if it matches the request to remove
                    if (!line.trim().isEmpty() && !line.startsWith("#")) {
                        String[] parts = line.split("\\|");
                        // Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                        if (parts.length >= 2) {
                            try {
                                int fileId = Integer.parseInt(parts[0].trim());
                                String fileTimestamp = parts[1].trim();
                                // Match by both ID and timestamp (file should have real ID when forwarded)
                                if (fileId == requestId && fileTimestamp.equals(timestamp)) {
                                    // Skip this line (don't add it to lines list)
                                    continue;
                                }
                            } catch (NumberFormatException e) {
                                // If ID parsing fails, try matching by timestamp only
                                String fileTimestamp = parts[1].trim();
                                if (fileTimestamp.equals(timestamp)) {
                                    continue;
                                }
                            }
                        }
                    }
                    
                    lines.add(line);
                }
            }
            
            // Write updated content back to file
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(txtFile))) {
                for (String line : lines) {
                    writer.write(line);
                    writer.newLine();
                }
                writer.flush();
            }
            
        } catch (IOException e) {
            System.err.println("Error removing request from requestformgarbagecollector.txt file: " + e.getMessage());
            e.printStackTrace();
        }
    }

    /**
     * Imports requests from a .txt file (pipe-delimited format).
     * Format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
     * 
     * @param file The .txt file to import from
     * @param defaultTargetRole The default target role if not specified (e.g., "Barangay Captain")
     * @return Number of requests successfully imported
     */
    public static int importRequestsFromTxt(File file, String defaultTargetRole) {
        if (file == null || !file.exists()) {
            return 0;
        }
        
        int imported = 0;
        int skipped = 0;
        
        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                line = line.trim();
                // Skip empty lines and comments
                if (line.isEmpty() || line.startsWith("#")) {
                    continue;
                }
                
                // Parse pipe-delimited format: id|timestamp|requester|barangay|type|location|description|numSacks|wasteType|status
                String[] parts = line.split("\\|");
                if (parts.length < 10) {
                    skipped++;
                    continue;
                }
                
                try {
                    // parts[0] = id (we'll ignore this, let DB generate new ID)
                    String timestamp = parts[1].trim();
                    String requester = parts[2].trim();
                    String barangay = parts[3].trim();
                    String requestType = parts[4].trim();
                    String location = parts[5].trim();
                    String description = parts[6].trim();
                    int numSacks = Integer.parseInt(parts[7].trim());
                    String wasteType = parts[8].trim();
                    String status = parts[9].trim();
                    
                    // Create request in database
                    int newId = RequestDAO.createRequest(timestamp, requester, barangay, requestType, 
                                                        location, description, numSacks, wasteType, 
                                                        status, defaultTargetRole);
                    if (newId > 0) {
                        imported++;
                    } else {
                        skipped++;
                    }
                } catch (NumberFormatException | SQLException e) {
                    System.err.println("Error importing line: " + line + " - " + e.getMessage());
                    skipped++;
                }
            }
            
            System.out.println("Import complete: " + imported + " requests imported, " + skipped + " skipped");
        } catch (IOException e) {
            System.err.println("Error reading file: " + e.getMessage());
            e.printStackTrace();
        }
        
        return imported;
    }
}