package dao;

import utils.DatabaseConfig;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * Data Access Object for Waste Record operations.
 * Handles all database interactions for the waste_records table.
 */
public class WasteRecordDAO {
    
    /**
     * Creates a new waste record.
     * @param role The user's role
     * @param date The date of the record
     * @param area The area/location
     * @param weight The weight in kg
     * @param type The waste type
     * @param barangay The barangay (optional, can be null)
     * @return The generated ID of the new record, or -1 if failed
     * @throws SQLException if database error occurs
     */
    public static int createWasteRecord(String role, String date, String area, double weight, String type, String barangay) throws SQLException {
        String sql = "INSERT INTO waste_records (role, date, area, weight, type, barangay) VALUES (?, ?, ?, ?, ?, ?)";
        
        try (Connection conn = DatabaseConfig.getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql, PreparedStatement.RETURN_GENERATED_KEYS)) {
            
            pstmt.setString(1, role);
            pstmt.setString(2, date);
            pstmt.setString(3, area);
            pstmt.setDouble(4, weight);
            pstmt.setString(5, type);
            pstmt.setString(6, barangay);
            
            int rows = pstmt.executeUpdate();
            
            if (rows > 0) {
                try (ResultSet rs = pstmt.getGeneratedKeys()) {
                    if (rs.next()) {
                        return rs.getInt(1); // Return generated ID
                    }
                }
            }
        }
        
        return -1; // Failed
    }
    
    /**
     * Creates a new waste record (overloaded method for backward compatibility).
     * @param role The user's role
     * @param date The date of the record
     * @param area The area/location
     * @param weight The weight in kg
     * @param type The waste type
     * @return The generated ID of the new record, or -1 if failed
     * @throws SQLException if database error occurs
     */
    public static int createWasteRecord(String role, String date, String area, double weight, String type) throws SQLException {
        return createWasteRecord(role, date, area, weight, type, null);
    }
    
    /**
     * Gets all waste records.
     * @return List of waste records {id, role, date, area, weight, type, barangay}
     * @throws SQLException if database error occurs
     */
    public static List<Object[]> getAllWasteRecords() throws SQLException {
        List<Object[]> records = new ArrayList<>();
        String sql = "SELECT id, role, date, area, weight, type, barangay FROM waste_records ORDER BY id DESC";
        
        try (Connection conn = DatabaseConfig.getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql);
             ResultSet rs = pstmt.executeQuery()) {
            
            while (rs.next()) {
                records.add(new Object[]{
                    rs.getInt("id"),
                    rs.getString("role"),
                    rs.getString("date"),
                    rs.getString("area"),
                    rs.getDouble("weight"),
                    rs.getString("type"),
                    rs.getString("barangay")
                });
            }
        }
        
        return records;
    }
    
    /**
     * Gets waste records by role.
     * @param role The role to filter by
     * @return List of waste records {id, role, date, area, weight, type, barangay}
     * @throws SQLException if database error occurs
     */
    public static List<Object[]> getWasteRecordsByRole(String role) throws SQLException {
        List<Object[]> records = new ArrayList<>();
        String sql = "SELECT id, role, date, area, weight, type, barangay FROM waste_records WHERE role = ? ORDER BY id DESC";
        
        try (Connection conn = DatabaseConfig.getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            pstmt.setString(1, role);
            
            try (ResultSet rs = pstmt.executeQuery()) {
                while (rs.next()) {
                    records.add(new Object[]{
                        rs.getInt("id"),
                        rs.getString("role"),
                        rs.getString("date"),
                        rs.getString("area"),
                        rs.getDouble("weight"),
                        rs.getString("type"),
                        rs.getString("barangay")
                    });
                }
            }
        }
        
        return records;
    }
    
    /**
     * Gets a waste record by ID.
     * @param id The record ID
     * @return Waste record {id, role, date, area, weight, type, barangay} or null if not found
     * @throws SQLException if database error occurs
     */
    public static Object[] getWasteRecordById(int id) throws SQLException {
        String sql = "SELECT id, role, date, area, weight, type, barangay FROM waste_records WHERE id = ?";
        
        try (Connection conn = DatabaseConfig.getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            pstmt.setInt(1, id);
            
            try (ResultSet rs = pstmt.executeQuery()) {
                if (rs.next()) {
                    return new Object[]{
                        rs.getInt("id"),
                        rs.getString("role"),
                        rs.getString("date"),
                        rs.getString("area"),
                        rs.getDouble("weight"),
                        rs.getString("type"),
                        rs.getString("barangay")
                    };
                }
            }
        }
        
        return null; // Record not found
    }
    
    /**
     * Updates a waste record.
     * @param id The record ID
     * @param date New date (null to keep current)
     * @param area New area (null to keep current)
     * @param weight New weight (null to keep current)
     * @param type New type (null to keep current)
     * @param barangay New barangay (null to keep current)
     * @return true if successful, false if record not found
     * @throws SQLException if database error occurs
     */
    public static boolean updateWasteRecord(int id, String date, String area, Double weight, String type, String barangay) throws SQLException {
        // Build dynamic SQL based on what fields to update
        StringBuilder sql = new StringBuilder("UPDATE waste_records SET ");
        List<String> updates = new ArrayList<>();
        List<Object> params = new ArrayList<>();
        
        if (date != null) {
            updates.add("date = ?");
            params.add(date);
        }
        if (area != null) {
            updates.add("area = ?");
            params.add(area);
        }
        if (weight != null) {
            updates.add("weight = ?");
            params.add(weight);
        }
        if (type != null) {
            updates.add("type = ?");
            params.add(type);
        }
        if (barangay != null) {
            updates.add("barangay = ?");
            params.add(barangay);
        }
        
        if (updates.isEmpty()) {
            return false; // Nothing to update
        }
        
        sql.append(String.join(", ", updates));
        sql.append(" WHERE id = ?");
        params.add(id);
        
        try (Connection conn = DatabaseConfig.getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql.toString())) {
            
            for (int i = 0; i < params.size(); i++) {
                pstmt.setObject(i + 1, params.get(i));
            }
            
            int rows = pstmt.executeUpdate();
            return rows > 0;
        }
    }
    
    /**
     * Updates a waste record (overloaded method for backward compatibility).
     * @param id The record ID
     * @param date New date (null to keep current)
     * @param area New area (null to keep current)
     * @param weight New weight (null to keep current)
     * @param type New type (null to keep current)
     * @return true if successful, false if record not found
     * @throws SQLException if database error occurs
     */
    public static boolean updateWasteRecord(int id, String date, String area, Double weight, String type) throws SQLException {
        return updateWasteRecord(id, date, area, weight, type, null);
    }
    
    /**
     * Deletes a waste record.
     * @param id The record ID to delete
     * @return true if successful, false if record not found
     * @throws SQLException if database error occurs
     */
    public static boolean deleteWasteRecord(int id) throws SQLException {
        String sql = "DELETE FROM waste_records WHERE id = ?";
        
        try (Connection conn = DatabaseConfig.getConnection();
             PreparedStatement pstmt = conn.prepareStatement(sql)) {
            
            pstmt.setInt(1, id);
            
            int rows = pstmt.executeUpdate();
            return rows > 0;
        }
    }
}